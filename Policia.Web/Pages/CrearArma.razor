@page "/arma/crear"
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager
@inject HttpClient Http

<PageTitle>Registrar Arma</PageTitle>

<div class="page-header">
    <div>
        <h2 class="page-title">‚ûï Registrar Nueva Arma</h2>
        <span class="page-subtitle">Agregar armamento al inventario</span>
    </div>
    <button class="btn-volver" @onclick='() => NavManager.NavigateTo("/inventario-armas")'>
        ‚Üê Volver al inventario
    </button>
</div>

<div class="form-card">
    <div class="form-section">
        <h3 class="section-title">üî´ Datos del Arma</h3>
        <div class="form-grid">
            <div class="form-group">
                <label>Tipo *</label>
                <select @bind="arma.IdTipo">
                    <option value="0">Seleccionar tipo...</option>
                    @foreach (var t in tipos)
                    {
                        <option value="@t.IdTipo">@t.Nombre</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Marca *</label>
                <input @bind="arma.Marca" placeholder="Ej: Glock, Beretta, SIG Sauer" />
            </div>
            <div class="form-group">
                <label>Modelo</label>
                <input @bind="arma.Modelo" placeholder="Ej: G17, 92FS, P320" />
            </div>
            <div class="form-group">
                <label>N¬∞ Serie *</label>
                <input @bind="arma.Serie" placeholder="Ej: ABC123456" />
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button class="btn-guardar" @onclick="Guardar" disabled="@guardando">
            @if (guardando)
            {
                <span class="btn-spinner"></span>
                <span>Guardando...</span>
            }
            else
            {
                <span>üíæ Registrar Arma</span>
            }
        </button>
    </div>

    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="form-mensaje @(exito ? "exito" : "error")">@mensaje</div>
    }
</div>

@code {
    ArmaFormDTO arma = new();
    List<TipoDTO> tipos = new();
    bool guardando = false;
    string mensaje = "";
    bool exito = false;

    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsync<string>("token_policial");
        if (string.IsNullOrEmpty(token)) { NavManager.NavigateTo("/login"); return; }

        tipos = await Http.GetFromJsonAsync<List<TipoDTO>>("logistica/armamento/tipos") ?? new();
    }

    async Task Guardar()
    {
        mensaje = "";

        if (arma.IdTipo == 0 || string.IsNullOrWhiteSpace(arma.Marca) || string.IsNullOrWhiteSpace(arma.Serie))
        {
            mensaje = "‚ö†Ô∏è Complete todos los campos obligatorios (*).";
            exito = false;
            return;
        }

        guardando = true;
        try
        {
            var respuesta = await Http.PostAsJsonAsync("logistica/armamento", arma);
            if (respuesta.IsSuccessStatusCode)
            {
                mensaje = "‚úÖ Arma registrada exitosamente.";
                exito = true;
                arma = new();
            }
            else
            {
                var error = await respuesta.Content.ReadAsStringAsync();
                mensaje = $"‚ùå {error}";
                exito = false;
            }
        }
        catch (Exception ex)
        {
            mensaje = "‚ùå Error de conexi√≥n: " + ex.Message;
            exito = false;
        }
        finally { guardando = false; }
    }

    // DTOs
    public class ArmaFormDTO
    {
        public int IdTipo { get; set; }
        public string? Marca { get; set; }
        public string? Modelo { get; set; }
        public string? Serie { get; set; }
    }

    public class TipoDTO { public int IdTipo { get; set; } public string? Nombre { get; set; } }
}
