@page "/crear-usuario"
@using Policia.Web.Models
@using System.Net.Http.Headers
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<PageTitle>Crear Usuario</PageTitle>

<div class="container mt-4">
    <h2>⚙️ Crear Usuario</h2>
    <hr />

    @* ──────────────────────────────────────────────
        SECCIÓN 1: BUSCAR POLICÍA POR CIP
        El admin escribe el CIP y hace click en "Buscar"
       ────────────────────────────────────────────── *@
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            🔍 Paso 1: Buscar Policía por CIP
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    @* 
                        @bind="cipBusqueda"
                        Lo que el admin escribe aquí se guarda automáticamente
                        en la variable cipBusqueda del código C#
                    *@
                    <input @bind="cipBusqueda" class="form-control"
                           placeholder="Ingrese el CIP del policía..." maxlength="8" />
                </div>
                <div class="col-md-4">
                    @*
                        @onclick="BuscarPersonal"
                        Cuando el admin hace click, se ejecuta el método BuscarPersonal()
                        disabled="@buscando" → Se deshabilita mientras busca (evita doble click)
                    *@
                    <button class="btn btn-primary w-100" @onclick="BuscarPersonal" disabled="@buscando">
                        @if (buscando)
                        {
                            <span>🔄 Buscando...</span>
                        }
                        else
                        {
                            <span>🔍 Buscar</span>
                        }
                    </button>
                </div>
            </div>

            @* Mensaje de error si el CIP no se encontró *@
            @if (!string.IsNullOrEmpty(mensajeBusqueda))
            {
                <div class="alert alert-warning mt-3">@mensajeBusqueda</div>
            }
        </div>
    </div>

    @* ──────────────────────────────────────────────
        SECCIÓN 2: DATOS DEL POLICÍA ENCONTRADO + FORMULARIO
        Solo se muestra cuando personalEncontrado NO es null
        Es decir, cuando la búsqueda fue exitosa
       ────────────────────────────────────────────── *@
    @if (personalEncontrado != null)
    {
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                ✅ Paso 2: Datos del Policía Encontrado
            </div>
            <div class="card-body">
                @*
                    Aquí mostramos los datos que vinieron de BD_RRHH
                    El operador ?. significa "si no es null, accede a la propiedad"
                    Si IdGradoNavigation es null, no explota → simplemente no muestra nada
                *@
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Nombres:</strong> @personalEncontrado.Nombres @personalEncontrado.Apellidos
                    </div>
                    <div class="col-md-6">
                        <strong>DNI:</strong> @personalEncontrado.Dni
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Grado:</strong> @personalEncontrado.IdGradoNavigation?.Nombre
                    </div>
                    <div class="col-md-4">
                        <strong>Unidad:</strong> @personalEncontrado.IdUnidadActualNavigation?.Nombre
                    </div>
                    <div class="col-md-4">
                        <strong>Situación:</strong> @personalEncontrado.IdSituacionNavigation?.Nombre
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                🔐 Paso 3: Asignar Credenciales
            </div>
            <div class="card-body">
                @* INPUT: Contraseña *@
                <div class="mb-3">
                    <label class="form-label">Contraseña:</label>
                    <input @bind="password" type="password" class="form-control"
                           placeholder="Ingrese la contraseña..." />
                </div>

                @* INPUT: Confirmar contraseña *@
                <div class="mb-3">
                    <label class="form-label">Confirmar Contraseña:</label>
                    <input @bind="confirmarPassword" type="password" class="form-control"
                           placeholder="Confirme la contraseña..." />
                </div>

                @* 
                    SELECT: Rol
                    <select> con @bind="idRolSeleccionado"
                    Lo que el admin selecciona se guarda en idRolSeleccionado
                    Los valores (1, 2) deben coincidir con los IdRol de tu tabla Rol
                *@
                <div class="mb-3">
                    <label class="form-label">Rol:</label>
                    <select @bind="idRolSeleccionado" class="form-select">
                        <option value="0">-- Seleccione un rol --</option>
                        <option value="1">Administrador</option>
                        <option value="2">Operador</option>
                    </select>
                </div>

                @* BOTÓN: Crear Usuario *@
                <button class="btn btn-success w-100" @onclick="CrearUsuarioDTO" disabled="@creando">
                    @if (creando)
                    {
                        <span>🔄 Creando usuario...</span>
                    }
                    else
                    {
                        <span>✅ Crear Usuario</span>
                    }
                </button>

                @* Mensajes de éxito o error *@
                @if (!string.IsNullOrEmpty(mensajeCreacion))
                {
                    <div class="alert @claseMensaje mt-3">@mensajeCreacion</div>
                }
            </div>
        </div>
    }
</div>

@code {
    // ──────────────────────────────────────────────
    // VARIABLES DE LA PÁGINA
    // ──────────────────────────────────────────────

    // Variables para la BÚSQUEDA
    string cipBusqueda = "";                           // Lo que el admin escribe en el input de búsqueda
    PersonalBuscadoDTO? personalEncontrado = null;     // Datos del policía encontrado (null si no se buscó aún)
    string mensajeBusqueda = "";                       // Mensaje de error/info de la búsqueda
    bool buscando = false;                             // true mientras se está buscando

    // Variables para la CREACIÓN
    string password = "";                              // Contraseña que el admin escribe
    string confirmarPassword = "";                     // Confirmar contraseña
    int idRolSeleccionado = 0;                         // Rol seleccionado en el <select>
    string mensajeCreacion = "";                       // Mensaje después de crear
    string claseMensaje = "";                          // Clase CSS del mensaje (verde=éxito, rojo=error)
    bool creando = false;                              // true mientras se está creando

    // ──────────────────────────────────────────────
    // AL CARGAR LA PÁGINA: Verificar que hay token
    // ──────────────────────────────────────────────
    // Esto es igual que en Home.razor y MisArmas.razor
    // Si no hay token, redirigimos al login
    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsync<string>("token_policial");

        if (string.IsNullOrEmpty(token))
        {
            NavManager.NavigateTo("/login", true);
            return;
        }

        // Configurar el HttpClient con el token para todas las peticiones
        Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
    }

    // ──────────────────────────────────────────────
    // MÉTODO 1: BUSCAR POLICÍA POR CIP
    // ──────────────────────────────────────────────
    // Se ejecuta cuando el admin hace click en "Buscar"
    // Llama a: GET /rrhh/Personal/buscar-cip/12345678
    async Task BuscarPersonal()
    {
        // Limpiar resultados anteriores
        personalEncontrado = null;
        mensajeBusqueda = "";
        mensajeCreacion = "";

        // Validar que el admin haya escrito algo
        if (string.IsNullOrWhiteSpace(cipBusqueda))
        {
            mensajeBusqueda = "⚠️ Ingrese un CIP para buscar.";
            return;
        }

        buscando = true;

        try
        {
            // Llamar al API de RRHH a través del Gateway
            // La ruta es: /rrhh/Personal/buscar-cip/{cip}
            //   - "rrhh" → ocelot.json lo redirige a Policia.RRHH.API (puerto 7120)
            //   - "Personal/buscar-cip/{cip}" → llega al PersonalController.BuscarPorCip()
            var respuesta = await Http.GetAsync($"rrhh/Personal/buscar-cip/{cipBusqueda}");

            if (respuesta.IsSuccessStatusCode)
            {
                // Si encontró al policía, deserializamos el JSON a nuestro DTO
                personalEncontrado = await respuesta.Content.ReadFromJsonAsync<PersonalBuscadoDTO>();
            }
            else if (respuesta.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                mensajeBusqueda = "❌ No se encontró ningún policía con el CIP: " + cipBusqueda;
            }
            else
            {
                mensajeBusqueda = "⚠️ Error al buscar. Código: " + respuesta.StatusCode;
            }
        }
        catch (Exception ex)
        {
            mensajeBusqueda = "❌ Error de conexión con el Gateway.";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            buscando = false;
        }
    }

    // ──────────────────────────────────────────────
    // MÉTODO 2: CREAR EL USUARIO
    // ──────────────────────────────────────────────
    // Se ejecuta cuando el admin hace click en "Crear Usuario"
    // Llama a: POST /seguridad/CrearUsuario
    async Task CrearUsuarioDTO()
    {
        mensajeCreacion = "";

        // ── VALIDACIONES DEL FORMULARIO ──

        // ¿Escribió la contraseña?
        if (string.IsNullOrWhiteSpace(password))
        {
            mensajeCreacion = "⚠️ Ingrese una contraseña.";
            claseMensaje = "alert-warning";
            return;
        }

        // ¿Las contraseñas coinciden?
        if (password != confirmarPassword)
        {
            mensajeCreacion = "⚠️ Las contraseñas no coinciden.";
            claseMensaje = "alert-warning";
            return;
        }

        // ¿Seleccionó un rol?
        if (idRolSeleccionado == 0)
        {
            mensajeCreacion = "⚠️ Seleccione un rol.";
            claseMensaje = "alert-warning";
            return;
        }

        creando = true;

        try
        {
            // Armamos el objeto que vamos a enviar al API
            var request = new CrearUsuarioRequest
            {
                Cip = personalEncontrado!.Cip,              // CIP del policía encontrado
                IdPersonal = personalEncontrado.IdPersonal,  // ID del policía en BD_RRHH
                Password = password,                         // Contraseña que escribió el admin
                IdRol = idRolSeleccionado                    // Rol seleccionado
            };

            // Enviamos POST al Gateway
            // "seguridad/CrearUsuario" → ocelot.json → Identity.API → AuthController.CrearUsuario()
            var respuesta = await Http.PostAsJsonAsync("seguridad/CrearUsuario", request);

            if (respuesta.IsSuccessStatusCode)
            {
                mensajeCreacion = $"✅ Usuario creado exitosamente para {personalEncontrado.Nombres} {personalEncontrado.Apellidos}";
                claseMensaje = "alert-success";

                // Limpiar el formulario para crear otro
                personalEncontrado = null;
                cipBusqueda = "";
                password = "";
                confirmarPassword = "";
                idRolSeleccionado = 0;
            }
            else if (respuesta.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                // 409 Conflict → Ya existe un usuario con ese CIP
                mensajeCreacion = "⚠️ Este policía ya tiene una cuenta de usuario.";
                claseMensaje = "alert-warning";
            }
            else
            {
                mensajeCreacion = "❌ Error al crear el usuario. Código: " + respuesta.StatusCode;
                claseMensaje = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            mensajeCreacion = "❌ Error de conexión con el Gateway.";
            claseMensaje = "alert-danger";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            creando = false;
        }
    }
}