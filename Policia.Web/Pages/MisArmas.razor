@page "/mis-armas"
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<PageTitle>Mi Armamento - PNP</PageTitle>

<div class="page-header">
    <div>
        <h2 class="page-title">🔫 Mi Armamento Asignado</h2>
        <span class="page-subtitle">Logística — PNP</span>
    </div>
</div>

@if (cargando)
{
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Consultando armamento...</span>
    </div>
}
else if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="error-state">@mensajeError</div>
}
else if (listaArmas.Count == 0)
{
    <div class="empty-state">
        <span class="empty-icon">🔒</span>
        <p>Usted no tiene armamento asignado actualmente.</p>
    </div>
}
else
{
    <div class="tabla-container">
        <table class="tabla-pnp">
            <thead>
                <tr>
                    <th>Tipo</th>
                    <th>Marca</th>
                    <th>N° Serie</th>
                    <th>Estado</th>
                    <th>Fecha Asignación</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in listaArmas)
                {
                    <tr>
                        <td><span class="badge-tipo">@item.IdArmaNavigation?.IdTipoNavigation?.Nombre</span></td>
                        <td>@item.IdArmaNavigation?.Marca</td>
                        <td><strong>@item.IdArmaNavigation?.Serie</strong></td>
                        <td>
                            @if (item.IdArmaNavigation?.Estado == "OPERATIVO")
                            {
                                <span class="badge-activo">OPERATIVO</span>
                            }
                            else
                            {
                                <span class="badge-retiro">@item.IdArmaNavigation?.Estado</span>
                            }
                        </td>
                        <td>@item.FechaEntrega.ToString("dd/MM/yyyy")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="tabla-footer">
        <span class="tabla-total">Total: <strong>@listaArmas.Count</strong> arma(s) asignada(s)</span>
    </div>
}

@code {
    // VARIABLES
    List<AsignacionArmaDTO> listaArmas = new List<AsignacionArmaDTO>();
    bool cargando = true;
    string mensajeError = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. SACAR LA PLACA DEL BOLSILLO
            var token = await LocalStorage.GetItemAsync<string>("token_policial");

            // Si no hay token, lo mandamos al login a patadas
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/login");
                return;
            }

            // 2. LEER EL ID DEL PERSONAL DESDE LOCALSTORAGE
            var idPersonal = await LocalStorage.GetItemAsync<int?>("id_personal");
            if (idPersonal == null || idPersonal == 0)
            {
                mensajeError = "⛔ No se pudo obtener su ID de personal. Vuelva a iniciar sesión.";
                return;
            }

            // 4. DISPARAR A LOGÍSTICA
            listaArmas = await Http.GetFromJsonAsync<List<AsignacionArmaDTO>>($"logistica/armamento/misarmas/{idPersonal}");
        }
        catch (HttpRequestException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                mensajeError = "⛔ SU SESIÓN HA EXPIRADO. Vuelva a ingresar.";
            }
            else if (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // La API retorna 404 cuando no hay armas asignadas → mostrar estado vacío
                listaArmas = new();
            }
            else
            {
                mensajeError = $"❌ Error al consultar: {ex.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            mensajeError = "❌ Error del sistema: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    // --- CLASES PARA ENTENDER EL JSON (DTOs) ---
    // (Esto evita que tengas que crear archivos separados por ahora)
    public class AsignacionArmaDTO
    {
        public DateOnly FechaEntrega { get; set; }
        public ArmaDTO IdArmaNavigation { get; set; }
    }

    public class ArmaDTO
    {
        public string Marca { get; set; }
        public string Serie { get; set; }
        public string Estado { get; set; }
        public TipoArmaDTO IdTipoNavigation { get; set; }
    }

    public class TipoArmaDTO
    {
        public string Nombre { get; set; }
    }
}