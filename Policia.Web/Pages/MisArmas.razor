@page "/mis-armas"
@using System.Net.Http.Headers
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<div class="container mt-4">
    <h2 class="mb-4">🔫 Mi Armamento Asignado</h2>

    @if (cargando)
    {
        <div class="alert alert-info">📡 Consultando a Logística con su Token...</div>
    }
    else if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger">@mensajeError</div>
    }
    else if (listaArmas.Count == 0)
    {
        <div class="alert alert-warning">Usted no tiene armamento asignado.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-bordered table-hover shadow">
                <thead class="table-dark">
                    <tr>
                        <th>Tipo</th>
                        <th>Marca</th>
                        <th>Serie</th>
                        <th>Estado</th>
                        <th>Fecha Asignación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in listaArmas)
                    {
                        <tr>
                            <td>@item.IdArmaNavigation?.IdTipoNavigation?.Nombre</td>
                            <td>@item.IdArmaNavigation?.Marca</td>
                            <td>@item.IdArmaNavigation?.Serie</td>
                            <td>
                                @if (item.IdArmaNavigation?.Estado == "OPERATIVO")
                                {
                                    <span class="badge bg-success">OPERATIVO</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">@item.IdArmaNavigation?.Estado</span>
                                }
                            </td>
                            <td>@item.FechaEntrega.ToShortDateString()</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    // VARIABLES
    List<AsignacionArmaDTO> listaArmas = new List<AsignacionArmaDTO>();
    bool cargando = true;
    string mensajeError = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. SACAR LA PLACA DEL BOLSILLO
            var token = await LocalStorage.GetItemAsync<string>("token_policial");

            // Si no hay token, lo mandamos al login a patadas
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/login");
                return;
            }

            // 2. PEGAR LA PLACA EN LA FRENTE (HEADER)
            // Esto es vital: Sin esto, el Gateway te responde "401 Unauthorized"
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // 3. LEER EL ID DEL PERSONAL DESDE LOCALSTORAGE
            var idPersonal = await LocalStorage.GetItemAsync<int?>("id_personal");
            if (idPersonal == null || idPersonal == 0)
            {
                mensajeError = "⛔ No se pudo obtener su ID de personal. Vuelva a iniciar sesión.";
                return;
            }

            // 4. DISPARAR A LOGÍSTICA
            listaArmas = await Http.GetFromJsonAsync<List<AsignacionArmaDTO>>($"logistica/armamento/misarmas/{idPersonal}");
        }
        catch (HttpRequestException ex)
        {
            if (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                mensajeError = "⛔ SU SESIÓN HA EXPIRADO. Vuelva a ingresar.";
            }
            else
            {
                mensajeError = $"❌ Error al consultar: {ex.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            mensajeError = "❌ Error del sistema: " + ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    // --- CLASES PARA ENTENDER EL JSON (DTOs) ---
    // (Esto evita que tengas que crear archivos separados por ahora)
    public class AsignacionArmaDTO
    {
        public DateOnly FechaEntrega { get; set; }
        public ArmaDTO IdArmaNavigation { get; set; }
    }

    public class ArmaDTO
    {
        public string Marca { get; set; }
        public string Serie { get; set; }
        public string Estado { get; set; }
        public TipoArmaDTO IdTipoNavigation { get; set; }
    }

    public class TipoArmaDTO
    {
        public string Nombre { get; set; }
    }
}